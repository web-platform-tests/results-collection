<!--
Copyright 2017 Google Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="/bower_components/polymer/polymer-element.html">
<link rel="import" href="/bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="/bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="/components/test-file-results.html">

<dom-module id="wpt-results">
  <template>
    <style>
      :host {
        display: block;
        font-size: 16px;
      }
      section.search {
        border-bottom: solid 1px #ccc;
        padding-bottom: 1em;
        margin-bottom: 1em;
      }
      input.query {
        font-size: 16px;
        display: block;
        padding: 0.5em 0;
        width: 100%;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th.browser img {
        width: 32px;
        height: 32px;
      }
      tr.spec {
        background-color: #eee;
      }
      tr td {
        padding: 0 0.5em;
      }
      tr.spec td {
        padding: 0.2em 0.5em;
        border: solid 1px #ccc;
      }
    </style>

    <template is="dom-if" if="{{ testFileName.length }}">
      <test-file-results style="margin-bottom: 5em;"
        test-runs="[[testRuns]]"
        test-file="[[testFileName]]">
      </test-file-results>
    </template>

    <template is="dom-if" if="{{ !testFileName.length }}">
      <section class="search">
        <input
          value="{{query::input}}"
          class="query"
          placeholder="Search test files, like cors/allow-headers.htm">
      </section>

      <table>
        <thead>
          <tr>
            <th>Spec</th>
            <template is="dom-repeat" items="{{testRuns}}">
              <th class="browser">
                <div><img src="/static/{{item.browser_name}}_64x64.png" /></div>
                <div>{{item.browser_name}} {{item.browser_version}}</div>
                <div>{{item.os_name}} {{item.os_version}}</div>
                <div>@{{item.revision}}</div>
                <div>{{_dateFormat(item.created_at)}}</div>
              </th>
            </template>
          </tr>
        </thead>
        <tbody>

          <template is="dom-repeat" items="{{displayedSpecDirs}}" as="specDir" id="spec_list">

            <tr class="spec">
              <td><b><a href="/{{specDir.specName}}">{{specDir.specName}}</a></b></td>

              <template is="dom-repeat" items="{{specDir.results}}" as="result">
                <td>{{ _passingPercent(result) }}% ({{ result.passing }} / {{ result.total }})</td>
              </template>
            </tr>

            <template is="dom-repeat" items="{{specDir.testFiles}}" as="testFile" class="test_file_list">
              <tr>
                <td><a href="{{ testFile.testFile }}">{{ testFile.testFile }}</a></td>

                <template is="dom-repeat" items="{{testFile.results}}" as="result">
                  <td style="{{ _testResultStyle(result) }}">
                    {{ _passingPercent(result) }}% ({{ result.passing }}/{{ result.total }})
                  </td>
                </template>
              </tr>
            </template>

            <template is="dom-if" if="{{ specDir.notAllTestFilesShown }}">
              <!-- TODO(jeffcarp): add a button to show more results -->
              <div>not all matching test files shown</div>
            </template>

          </template>
        </tbody>
      </table>
    </template>

  </template>

  <script>
    class WPTResults extends window.Polymer.Element {
      static get is () { return 'wpt-results' }

      static get properties () {
        return {
          query: {
            type: String,
            value: '',
            observer: '_queryChanged'
          },
          // An object where the key is a top-level directory in WPT (top-level
          // directories are spec names) and the value is an object containing
          // all test files in the spec directory.
          specDirs: {
            type: Object,
            value: {}
          },
          displayedSpecDirs: {
            type: Array,
            value: []
          },
          testRuns: {
            type: Array,
          },
          // If any directory names are present, displayedSpecDirs should be a
          // union of filteredDirectories, not an intersection.
          filteredDirectories: {
            type: Array,
            value: []
          },
          testFileName: {
            type: String,
            value: ''
          }
        }
      }

      async connectedCallback () {
        super.connectedCallback()

        if (window.location.pathname !== '/') {
          this.filteredDirectories.push(window.location.pathname)
        }

        // TODO is this an ok assumption?
        if (window.location.pathname.endsWith('.html')) {
          this.testFileName = window.location.pathname
          return
        }

        const testFileResults = await Promise.all(this.testRuns.map(testRun => {
          return this._fetchResults(testRun.results_url)
        }))

        testFileResults.forEach(result => {
          const testFiles = result.testFiles
          const resultsURL = result.resultsURL

          Object.keys(result.testFiles).forEach(testFileName => {
            const specName = this._specFromTestPath(testFileName)

            if (!(specName in this.specDirs)) {
              this.specDirs[specName] = {results: {}, specName: specName, testFiles: {}}
            }
            if (!(resultsURL in this.specDirs[specName].results)) {
              this.specDirs[specName].results[resultsURL] = {resultsURL: resultsURL, passing: 0, total: 0}
            }
            this.specDirs[specName].results[resultsURL].passing += testFiles[testFileName][0]
            this.specDirs[specName].results[resultsURL].total += testFiles[testFileName][1]
            if (!(testFileName in this.specDirs[specName].testFiles)) {
              this.specDirs[specName].testFiles[testFileName] = {testFile: testFileName, results: {}}
            }
            if (!(resultsURL in this.specDirs[specName].testFiles[testFileName].results)) {
              this.specDirs[specName].testFiles[testFileName].results[resultsURL] = {resultsURL: resultsURL, passing: 0, total: 0}
            }
            this.specDirs[specName].testFiles[testFileName].results[resultsURL].passing = testFiles[testFileName][0]
            this.specDirs[specName].testFiles[testFileName].results[resultsURL].total = testFiles[testFileName][1]
          })
        })

        this._refreshDisplayedSpecDirs()
      }

      _testFileSort (a, b) {
        if (a.testFile < b.testFile) return -1
        if (a.testFile > b.testFile) return 1
        return 0
      }

      _specDirSort (a, b) {
        if (a.specName < b.specName) return -1
        if (a.specName > b.specName) return 1
        return 0
      }

      _resultWithRunIndex (results, runIndex) {
        for (var key in results) {
          if (results[key].runIndex === runIndex) {
            return results[key]
          }
        }
      }

      _specFromTestPath (path) {
        return path.split('/')[1]
      }

      async _fetchResults (url) {
        const response = await window.fetch(url)
        const testFiles = await response.json()
        return {testFiles: testFiles, resultsURL: url}
      }

      _queryChanged () {
        this._refreshDisplayedSpecDirs()
      }

      _refreshDisplayedSpecDirs () {
        /* Recomputes the list of displayed spec directories and their child test results. */
        const matchesQuery = (tf) => tf.testFile.toLowerCase().includes(this.query.toLowerCase())
        const displayedSpecDirs = []

        for (var key in this.specDirs) {
          let specDir = this.specDirs[key]
          let displaySpecDir = {}

          displaySpecDir.specName = specDir.specName
          displaySpecDir.results = this.testRuns.map(testRun => specDir.results[testRun.results_url])

          if (this.filteredDirectories.length > 0) {
            const inFilteredDir = this.filteredDirectories.some(filterDir => (
              filterDir.startsWith(`/${displaySpecDir.specName}`)
            ))
            if (!inFilteredDir) {
              continue
            }
          }

          if (this.query.length < 3 && this.filteredDirectories.length === 0) {
            displaySpecDir.testFiles = []
            displayedSpecDirs.push(displaySpecDir)
            continue
          }

          let allTestFiles = Object.keys(specDir.testFiles).map(k => {
            let displayTestFile = {}
            let originalTestFile = specDir.testFiles[k]

            displayTestFile.testFile = originalTestFile.testFile
            displayTestFile.results = this.testRuns.map(testRun => originalTestFile.results[testRun.results_url])

            return displayTestFile
          })

          const MAX_RESULTS_PER_SPEC_DIR = 10

          let matchingTestFiles = allTestFiles.filter(matchesQuery)
          if (matchingTestFiles.length > 0) {
            if (this.filteredDirectories.length > 0) {
              displaySpecDir.testFiles = matchingTestFiles
              displaySpecDir.testFiles = displaySpecDir.testFiles.filter(tf => (
                this.filteredDirectories.some(filterDir => tf.testFile.startsWith(filterDir))
              ))
            } else {
              displaySpecDir.testFiles = matchingTestFiles.slice(0, MAX_RESULTS_PER_SPEC_DIR)
              displaySpecDir.notAllTestFilesShown = matchingTestFiles.length > MAX_RESULTS_PER_SPEC_DIR
            }

            displaySpecDir.testFiles.sort(this._testFileSort)
            displayedSpecDirs.push(displaySpecDir)
          }
        }
        displayedSpecDirs.sort(this._specDirSort)
        this.set('displayedSpecDirs', displayedSpecDirs)
      }

      _passingPercent (item) {
        if (!item || isNaN(item.passing) || isNaN(item.total)) return ''
        return parseFloat((item.passing / item.total) * 100).toFixed(1)
      }

      _platformID (testRun) {
        return `${testRun.browser_name}-${testRun.browser_version}-${testRun.os_name}-${testRun.os_version}`
      }

      /* Function for getting total numbers.
       * Intentionally not exposed in UI.
       * To generate, open your console and run:
       * document.querySelector('wpt-results').generateTotalPassNumbers()
       */
      generateTotalPassNumbers () {
        const totals = {}

        this.testRuns.forEach(testRun => {
          const testRunID = this._platformID(testRun)
          totals[testRunID] = {passing: 0, total: 0}

          Object.keys(this.specDirs).forEach(specKey => {
            totals[testRunID].passing += this.specDirs[specKey].results[testRun.results_url].passing
            totals[testRunID].total += this.specDirs[specKey].results[testRun.results_url].total
          })
        })

        Object.keys(totals).forEach(key => {
          totals[key].percent = (totals[key].passing / totals[key].total) * 100
        })

        console.table(Object.keys(totals).map(k => ({
          platformID: k,
          passing: totals[k].passing,
          total: totals[k].total,
          percent: totals[k].percent
        })))

        console.log('JSON version:', JSON.stringify(totals))
      }

      _dateFormat (dateStr) {
        return String(new Date(dateStr)).match(/^\w+ (\w+ \w+ \w+)/)[1]
      }

      _testResultStyle (result) {
        if (!result) return ''

        // Need saturation between 65-100, reversed (range 35)
        const passRate = result.passing / result.total
        if (passRate === 1) {
          // Green
          return 'background-color: hsl(129, 85%, 65%)'
        } else {
          const luminance = 65 + passRate * 20
          // Some shade of red
          return `background-color: hsl(0, 85%, ${luminance}%)`
        }
      }
    }

    window.customElements.define(WPTResults.is, WPTResults)
  </script>
</dom-module>
