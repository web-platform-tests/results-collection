#!/usr/bin/python3

# Copyright 2017 Google Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

"""
Tool for pulling a local copy of the JSON for a given run ,and saving the files
in the 'static' dir. This tool is intended for updating the pre-population
output of /tasks/populate-dev-data, and a change including the content
generated by this tool should also update the content in
populate_dev_data_handler.go

Example usage:
./add_production-run.py --sha=b952881825
"""

import argparse
import certifi
import inspect
import json
import logging
import os
from urllib.parse import urlencode
import urllib3

here = os.path.dirname(__file__)


def main():
    args = parse_flags()  # type: argparse.Namespace

    loggingLevel = getattr(logging, args.log.upper(), None)
    logging.basicConfig(level=loggingLevel)

    sha = args.sha  # type: str

    pool = urllib3.PoolManager(
            cert_reqs='CERT_REQUIRED',
            ca_certs=certifi.where())
    encodedArgs = urlencode({ 'sha': sha })
    url = 'https://wpt.fyi/api/runs?' + encodedArgs

    # type: urllib3.response.HTTPResponse
    response = pool.request('GET', url)

    if response.status != 200:
        logging.warning('Failed to fetch %s' % (url))
        return
    logging.debug('Processing JSON from %s' % (url))
    tests = json.loads(response.data.decode('utf-8'))

    for test in tests:
        encodedArgs = urlencode({
            'sha': test['revision'],
            'platform': test['browser_name']
        })
        url = 'http://localhost:8080/api/run?' + encodedArgs
        logging.debug("Fetching %s" % url)
        response = pool.request('GET', url)
        if response.status == 404:
            logging.warning('Skipping TestRun %s@%s (already present)'
                            % (test['browser_name'], test['revision']))
            continue

        postUrl = 'http://localhost:8080/test-runs'
        try:
            response = pool.request('POST', postUrl, test)
        except IOError as e:
            logging.warning("Failed to POST %s" % (postUrl))

        logging.info("%s: %s"
                     % (response.status, response.data.decode('utf-8')))


# Create an ArgumentParser for the flags we'll expect.
def parse_flags():  # type: () -> argparse.Namespace
    # Re-use the docs above as the --help output.
    parser = argparse.ArgumentParser(description=inspect.cleandoc(__doc__))
    parser.add_argument(
        '--sha',
        default='latest',
        help='SHA[0:10] of the run to fetch')
    parser.add_argument(
        '--log',
        type=str,
        default='INFO',
        help='Log level to output')
    return parser.parse_args()


if __name__ == '__main__':
    main()
